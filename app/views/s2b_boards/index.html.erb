<%= render :partial => "/shared/plugin_header", :locals => {:is_board => true, :member => @member, :list_versions_open => @list_versions_open, :list_versions_closed => @list_versions_closed} %>

<div id="div_screen_board">

  <% columns = [{:column_id => :new_column, :status => "new", :column_name => l(:label_board_status_new), :issues => @new_issues },
                {:column_id => :in_progress_column, :status => "in_progress", :column_name => l(:label_board_status_inprogress), :issues => @in_progress_issues },
                {:column_id => :completed_column, :status => "completed", :column_name => l(:label_board_status_completed), :issues => @completed_issues }
               ]
  %>
  <% columns.each do |column| %>
    <div class="board box" status="<%= column[:status].to_s %>" id="<%= column[:column_id].to_s %>">
      <%= render :partial => "board_column", :locals => column %>
    </div>
  <% end %>
</div>

<script language="JavaScript" >
  function show_and_hide_close_issue_icon() {
    $("#completed_column .icon_close_issue").show();
    $("#new_column .icon_close_issue").hide();
    $("#in_progress_column .icon_close_issue").hide();
  }

  $(document).ready(function() {
    show_and_hide_close_issue_icon();
    
    $( "#date_start_").datepicker();
    $( "#date_end_").datepicker();
    $( "#date_start_").datepicker("option", "dateFormat", "yy-mm-dd");
    $( "#date_end_").datepicker("option", "dateFormat", "yy-mm-dd");
    
    $(".icon_new_issue").click(function(){
      $("#new_issue_form").show();
    });
    
    $(".icon_close_issue").live("click",function(){
      if(!confirm('<%= l(:label_sure_to_close_issues)%>')){
        return;
      }

      var issue_id = $(this).parents('li').attr("id");
      var project_id = '<%= @project.id %>';

      $.ajax({
        url : 'close_issue',
        type : "POST",
        data : 'issue_id=' + issue_id + '&project_id=' + project_id,
        dataType : "json",
        success : function(data) {
          if(data.result == 'success'){
            $('#completed_column .connectedSortable').html(data.content);
            show_and_hide_close_issue_icon();
            $("#completed_column li").each(function() {
              var issue_id = $(this).attr("id");
              var slide_value = $(this).find(".board_issue").attr("slide_value");
              makeSlider(issue_id, slide_value);
              editDate(issue_id); 
              form_edit(issue_id);
            });
          }else{
            alert(data.message);
          }
        }
      });
      return false;
    });
    
    $("#btn_filter_issues_on_board").live("click",function(){
      var select_version = $("#select_version_onboard").val();
      var select_member = $("#select_member").val();
      var project_id = '<%= @project.id %>';
      $.ajax({
        url : 'filter_issues',
        type : "POST",
        data : 'select_version=' + select_version + '&select_member=' + select_member + '&project_id=' + project_id,
        dataType : "script",
        success : function() {}
      });
      return false;
    });
    
    $( "#new_column .connectedSortable, #in_progress_column .connectedSortable, #completed_column .connectedSortable").sortable({
      scroll: true, 
      scrollSensitivity: 100, 
      scrollSpeed: 100,
      connectWith: ".connectedSortable",
      sort: function(){
        $(this).find(".ui-sortable-helper").addClass("check");
      },
      receive: function(){
        var status = $(this).parents(".box").attr("status");
        var project_id = <%= @project.id %>;
        var issue_id = $(this).find("li").attr("id");
        show_and_hide_close_issue_icon();
        
        $.ajax({
          url : 'update_status',
          type : "POST",
          data : 'issue_id=' + issue_id + '&project_id=' + project_id + '&status=' + status,
          dataType : "json",
          success : function(res) {
             if (res.status == "completed"){
                makeSlider(issue_id,res.done_ratio);
             }
          }
        });
      },
      stop: function() {
        var issue_id = $(".check").attr("id");
        var url_sort = 'sort'
        var project_id = <%= @project.id %>;
        var id_next = $(".check").next().attr("id");
        var id_prev = $(".check").prev().attr("id");
        var old_status = $(this).attr("value");
        var new_status = $(".check").parent().attr("value");
        $(".check").removeClass("check");
          console.debug(id_prev);
          $.ajax({
          url : url_sort,
          type : "POST",
          data : 'issue_id=' + issue_id +'&id_prev=' + id_prev + '&project_id=' + project_id + '&id_next=' + id_next + '&new_status=' + new_status + '&old_status=' + old_status,
          dataType : "text",
          success : function(){
          }
        });
      }
    });

    $(".slider-horizontal").each(function() {
      var id = parseInt($(this).parent().attr("value"));
      var slide_value = $(this).attr("value");
      makeSlider(id, slide_value);
    });

    $(".progressbar").each(function() {
      var id = parseInt($(this).parent().attr("value"))
      $("#progress"+id).progressbar({
        value:parseInt($(this).attr("value"))
       });
    });

    $(".icon_edit_issue").live("click", function(){
      $(this).parents(".show_form").hide();
      $(this).parents(".issue").find(".edit_form").show();
    });

    $(".cancel_issue").live("click", function(){
      if($(this).parents("li").attr("id") == "new_issue_form") {
        $(this).parents("li").hide();
      }else{
        $(this).parents(".edit_form").hide();
        $(this).parents(".issue").find(".show_form").show();
      }
    });

    $(".submit_issue").live("click", function(){
      var id_issue = $(this).parent().attr("value");
      if(id_issue != "" ){
        $.ajax({
          url : "update",
          type : "POST",
          data: $('#update_issue_' + id_issue).serialize(),
          dataType : "json",
          success : function(data) {
            if(data.result == "success") {
              $("li#" + id_issue).html(data.content);
              makeSlider(id_issue, slide_value);
              show_and_hide_close_issue_icon();
              editDate(id_issue); 
              form_edit(id_issue);
            }else{
              alert(data.message);
            }
          }
        });
      }else{
        $.ajax({
          url : "create",
          type : "POST",
          data: $('#update_issue_').serialize(),
          dataType : "json",
          success : function(data) {
            if(data.result == "success"){
              $("#new_issue_form").find(".value_content").val("");
              $("#new_issue_form").hide();
              $("#new_issue_form").parent().find(".connectedSortable").prepend(data.content);
              makeSlider(data.id, 0);
              editDate(data.id); 
              form_edit(data.id);
            }
            else{
              alert(data.message);
            }
          }
        });
      }
      
      var slide_value = $("#slider" + id_issue).attr("value");
      $.ajax({
        url : url_ajax,
        type : "POST",
        data: $('#update_issue_' + id_issue).serialize(),
        dataType : "json",
        success : function(data) {
          if(data.result == "edit_success") {
            console.debug("get value :" + data.edit_content);
            $("#show_issue_" + id_issue).replaceWith(data.content).show();
            makeSlider(id_issue, slide_value);
            $("#edit_issue_" + id_issue).replaceWith(data.edit_content).hide();
            editDate(id_issue); 
            form_edit(id_issue);
            show_and_hide_close_issue_icon();
          }else if(data.result == "create_success"){
            $("#new_issue_form").find(".value_content").val("");
            $("#new_issue_form").hide();
            $("#new_issue_form").parent().find(".connectedSortable").prepend(data.content);
            makeSlider(data.id, 0);
            editDate(data.id); 
            form_edit(data.id);
          }
          else{
            alert(data.message);
          }
        }
      });
    });

    $(".edit_form").each(function() {
      var id = $(this).attr("value");
      editDate(id);
      if( id != ""){ 
        form_edit(id);
      }
    })
    
    $(".readmore").live("click", function(){
      var id = $(this).attr("value");
      $(this).hide();
      $("#hide_" + id).show();
      $("#description_readmore_" + id).show();
      $("#description_hide_" + id).hide();
      return false;
    });

    $(".hide").live("click", function() {
      var id = $(this).attr("value");
      $(this).hide();
      $("#readmore_" + id).show();
      $("#description_hide_" + id).show();
      $("#description_readmore_" + id).hide();
      return false;
    });

  }); 
  
  function form_edit(id){
    $("#p_status_" + id).hide();
    $("#p_priority_" + id).hide();
    $("#p_tracker_" + id).hide();
    $("#p_sprint_" + id).hide(); 
  }

  function editDate(id){
    $("#new_date_start_" + id).datepicker();
    $("#new_date_end_" + id).datepicker();
    $("#new_date_start_" + id).datepicker("option", "dateFormat", "yy-mm-dd");
    $("#new_date_end_" + id).datepicker("option", "dateFormat", "yy-mm-dd");  
  }
  
  function makeSlider(id, slide_value) {
    $("#slider" + id ).slider({
      orientation: "horizontal",
      range: "min",
      min: 0,
      max: 100,
      value: parseInt(slide_value),
      slide: function( event, ui ) {
        $("#amount"+id ).val( ui.value );
      },
      stop: function(e, ui) {
        var issue_id = parseInt($(this).parent().attr("value"));
        var project_id = <%= @project.id %>;
        var url_ajax = "update_progress";
        $.ajax({
          url : url_ajax,
          type : "POST",
          data : 'done_ratio=' + ui.value + '&issue_id=' + issue_id + '&project_id='+project_id,
          dataType : "json",
          success : function(res) {
            $("#slider" + issue_id).attr("value", ui.value);
          }
        });
      }
    });
    $("#amount" + id ).val( $("#slider" + id).slider("value"));
    $("#main-menu .s2b-lists").addClass("selected");
  }
</script>